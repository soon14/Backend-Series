# 内存

和内存相关的指标主要有以下几个，常用的分析工具有：top、free、vmstat、pidstat 以及 JDK 自带的一些工具。

- 系统内存的使用情况，包括剩余内存、已用内存、可用内存、缓存/缓冲区；
- 进程（含 Java 进程）的虚拟内存、常驻内存、共享内存；
- 进程的缺页异常数，包含主缺页异常和次缺页异常；
- Swap 换入和换出的内存大小、Swap 参数配置；
- JVM 堆的分配，JVM 启动参数；
- JVM 堆的回收，GC 情况。

使用 free 可以查看系统内存的使用情况和 Swap 分区的使用情况，top 工具可以具体到每个进程，如我们可以用使用 top 工具查看 Java 进程的常驻内存大小（RES），这两个工具结合起来，可用覆盖大多数内存指标。下面是使用 free 命令的输出：

```sh
$ free -h
              total        used        free      shared  buff/cache   available
Mem:           125G        6.8G         54G        2.5M         64G        118G
Swap:          2.0G        305M        1.7G
```

Swap 的作用就是把一块磁盘空间或者一个本地文件当成内存来使用，包括换出和换入两个过程。Swap 需要读写磁盘数据，所以性能不是很高，事实上，包括 ElasticSearch 、Hadoop 在内绝大部分 Java 应用都建议关掉 Swap，这是因为内存的成本一直在降低，同时这也和 JVM 的垃圾回收过程（GC）有关：JVM 在 GC 的时候会遍历所有用到的堆的内存，如果这部分内存被 Swap 出去了，遍历的时候就会有磁盘 I/O。Swap 分区的升高一般和磁盘的使用强相关，具体分析时，需要结合缓存时候用、swappiness 阈值以及匿名页和文件页的活跃情况综合分析。

buff/cache 是缓存和缓冲区的大小。缓存（cache）：是从磁盘读取的文件的或者向磁盘写文件时的临时存储数据，面向文件。使用 cachestat 可以查看整个系统缓存的读写命中情况，使用 cachetop 可以观察每个进程缓存的读写命中情况。缓冲区（buffer）是写入磁盘数据或从磁盘直接读取的数据的临时存储，面向块设备。free 命令的输出中，这两个指标是加在一起的，使用 vmstat 命令可以区分缓存和缓冲区，还可以看到 Swap 分区换入和换出的内存大小。

了解到常见的内存指标后，常见的内存问题又有哪些？总结如下：

- 系统剩余内存/可用不足（某个进程占用太多、系统本身内存不足），内存溢出；
- 内存回收异常：内存泄漏（进程在一段时间内内存使用持续走高）、GC 频率异常；
- 缓存使用过大（大文件读取或写入）、缓存命中率不高；
- 缺页异常过多（频繁的 I/O 读）；
- Swap 分区使用异常（使用过大）；

内存相关指标异常后，分析思路是怎么样的？

- 用 free/top 查看内存的全局使用情况，如系统内存的使用、Swap 分区内存使用、缓存/缓冲区占用情况等，初步判断内存问题存在的方向：进程内存、缓存/缓冲区、Swap 分区；

- 观察一段时间内存的使用趋势。如通过 vmstat 观察内存使用是否一直在增长；通过 jmap 定时 dump 对象列表，判断是否存在内存泄漏，通过 cachetop 命令，定位缓冲区升高的根源等；

- 根据内存问题的类型，结合应用本身，进行详细分析。

使用 free 发现缓存/缓冲区占用不大，排除缓存/缓冲区对内存的影响后 -> 使用 vmstat 或者 sar 观察一下各个进程内存使用变化趋势 -> 发现某个进程的内存时候用持续走高 -> 如果是 Java 应用，可以使用 jmap / VisualVM / heap dump 分析等工具观察对象内存的分配，或者通过 jstat 观察 GC 后的应用内存变化 -> 结合业务场景，定位为内存泄漏/GC 参数配置不合理/业务代码异常等。
