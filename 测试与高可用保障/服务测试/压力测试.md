[![](https://i.postimg.cc/WzXsh0MX/image.png)](https://github.com/wx-chevalier/Backend-Series)

# 压力测试

在运维工作中，压力测试是一项很重要的工作。比如在一个网站上线之前，能承受多大访问量、在大访问量情况下性能怎样，这些数据指标好坏将会直接影响用户体验。但是，在压力测试中存在一个共性，那就是压力测试的结果与实际负载结果不会完全相同，就算压力测试工作做的再好，也不能保证 100% 和线上性能指标相同。面对这些问题，我们只能尽量去想方设法去模拟。所以，压力测试非常有必要，有了这些数据，我们就能对自己做维护的平台做到心中有数。

我们通常说的网站流量(traffic)就是指网站的访问量，是用来描述访问一个网站的用户数量以及用户所浏览的网页数量等指标，常用的统计指标包括网站的独立用户数量、总用户数量(含重复访问者)、网页浏览数量、每个用户的页面浏览数量、用户在网站的平均停留时间等。

# Metrics(产品度量)

我们通常说的网站流量(traffic)就是指网站的访问量，是用来描述访问一个网站的用户数量以及用户所浏览的网页数量等指标，常用的统计指标包括网站的独立用户数量、总用户数量(含重复访问者)、网页浏览数量、每个用户的页面浏览数量、用户在网站的平均停留时间等。

网站访问量的衡量标准一个是 IP,另一个是 PV,常以日为标准,即日独立 IP 和 PV 来计算.

    访问数(IP)：即Internet Protocol,指独立IP数。00:00-24:00内相同IP地址只被计算一次。

    综合浏览量(PV)：即Page View, 即页面浏览量或点击量，用户每次刷新即被计算一次。

    二者的联系与区别：PV高不一定代表来访者多；PV与来访者的数量成正比，但是PV并不直接决定页面的真实来访者数量。比如一个网站就你一个人进来，通过不断的刷新页面，也可以制造出非常高的PV。

IP 是一个反映网络虚拟地址对象的概念，独立用户是一个反映实际使用者的概念，每个独立用户相对于每个 IP，更加准确地对应一个实际的浏览者。使用独立用户作为统计量，可以更加准确的了解单位时间内实际上有多少个访问者来到了相应的页面。

一个独立 IP 可以产生多个 PV,所以 PV 个数>=IP 个数。

    PV(Page View)值：是指一定时间范围内所有浏览该网站的访问者请求的页面数量之合。(例如：该网站一天有500个访问者，每个访问者浏览的页面数量平均为8页，则每天的PV是500×8=4000)

    Hits值：是指对每个页面元素的请求数量。(一个页面中任何一个图片或者flash文件都算是一个页面元素)

    日浏览字节数：即日流量，是指一天内，访问者请求的所有页面元素的字节数之和。

计算带宽大小需要关注两个指标：峰值流量和页面的平均大小。举个例子说明下吧:

    假设网站的峰值流量是平均流量的5倍(当然，这只是一个假设，具体实施我们需要视自己情况而定)；

    假设每次访问的平均页面大小是200K字节；

    假设网站的预期目标是每天50W PV的访问量。

我们的计算开始：50W

PV 如果在一天内平均分布，折合到每秒大概是 50W/(24*60*60)=6 次访问，按照我们之前的假设平均页面大小是 200K 字节计算，这 6 次访问总

共就是 1200K 字节(需要注意的是这个地方是字节)，字节的单位是 Byte，而带宽的单位是 bit，1Byte=8bit，因此 1200K

Byte 大概就是 9600K

bit，也就是 9Mbps(1M=1024K)。在实际的网站运行过程中，我们的网站必须要在峰值流量时保持正常的访问，这里就会用到我们之前的假设，峰

值流量是平均流量的 5 倍，按照这个计算，实际需要的带宽大约在 9Mbps\*5=45Mbps 左右。

**具体的计算公式是：网站独享带宽=一天总的 PV 值 ÷ 一天总时间(换算到 S\*平均页面大小(单位 KB)\* 8**

     这个计算结果的前提是我们之前的三条假设，而在实际运行中，由于缓存、网站提供下载、图片较多、网站白天夜里访问量不同等原因，这个结果可能并不是很理想。所以这个算法只能算是一个大概的算法了。

eg. 10w pv,页面大小 1M ，带宽=10,0000/86400*1M*8 = 9.26Mbps

**PV 与并发之间换算的算法换算公式**

并发连接数 = PV / 统计时间 _ 页面衍生连接次数 _ http 响应时间 \* 因数 / web 服务器数量

PV = 并发连接数 _ 统计时间 _ web 服务器数量/ 页面衍生连接次数 / http 响应时间 / 因数

解释：

统计时间 : pv 统计的总时间，单位秒，要计算一天的 pv 就是 86400 秒

页面衍生连接次数: 一个 HTML 页面可能会请求好几次 http 连接，如外部的 css, js,图片等,可以估算一下，或者用 10,可根据实际情况改变

http 响应时间: 可以使用 1 秒或更少,可根据实际情况改变

因数: 一般使用 5 即可,可根据实际情况计算后推出

web 服务器数量: web 服务器数量

\* "页面衍生连接次数"，"http 响应时间"，"因数"这三个参数要根据实际情况分析计算后，确定一个适合的值

推算一下。单台机器 1000 并发的情况下，一天是 1,728,000 的 pv(1 秒响应，10 个衍生连接，因子为 5 的情况下)

例子：

保证每天多少 PV 的并发连接数的计算公式是：

并发连接数＝ PV / 统计时间(一天是 86400) _ 页面衍生连接次数 _ http 响应时间 \* 因数(5) / web 服务器数量

保证 4 千万 PV 的并发连接数：

(40000000PV / 86400 秒 _ 10 个派生连接数 _ 5 秒内响应 \* 5 倍峰值) / 6 台 Web 服务器 = 19290 连接数

eg.

10PV 的并发连接数：

# (100000PV / 86400 秒 _ 10 个派生连接数 _ 5 秒内响应 \* 5 倍峰值) / 1 台 Web 服务器 = 289 连接数

# 数据库压力测试

```
sudo aptitude install sysbench
echo "create database sbtest; grant all on sbtest.* to 'sbtest'@'localhost';" | mysql
sysbench --test=oltp --num-threads=10 prepare
sysbench --test=oltp --num-threads=10 run

sysbench --test=oltp --num-threads=16 --max-requests=100000 --mysql-socket=/var/lib/mysql/mysql.sock --mysql-user=root --db-driver=mysql --oltp-test-mode=complex run
```

随着 NoSql 数据存储方式的使用率增加，以及多存储方式混合解决方案日趋流行，开发团队在需要存储数据时有了多种选择。虽然这能带来很多益处，但是在不稳定的网络环境下产品行为有可能出现微妙的(以及不那么微妙的)问题，而这些问题有时即便是产品开发人员自己也难以理解。当任何人试图了解不同数据库和队列技术在不同场景下如何反应时，事实上都会把 Jepsen 及其博客作为参考。关键一点，使用这种在事务中包含客户端的方法来测试，给许多构建微服务的团队揭示了可能的错误模式。
