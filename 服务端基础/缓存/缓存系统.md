# 缓存系统设计

常见的缓存系统会采取 Key-Value 的非结构化存储，其需要具备的标准特性是：高性能、高扩展与高可靠。其高性能往往采取高速缓存、内存或 SSD 等存储方案，高扩展会综合应用多种存储引擎，并通过中间件或者负载均衡等方式保证扩展能力，而高可用则类似于我们在高可用架构中讨论的，需要有多种容灾与隔离方案。

# 数据引擎

## Memcache

Memcache 是基于内存的数据库，仅支持 KV 类型数据，不支持持久化。它适用于数据小而简单，读多（QPS 万以上）写少，且偶尔数据丢失不应该对业务产生较大影响；例如访问量显示，session manager等功能。

## Redis

Redis 是基于内存的数据库，除了标准的 KV 类型，还支持 String，List，Hash，Set，SortedSet 等复杂类型。它适用于数据形式复杂，偶尔数据丢失不应该对业务产生较大影响；例如排行榜、最新项目检索、地理位置存储及range查询。

## LevelDB

LevelDB 是基于 SSD 硬盘，仅支持 KV 类型数，支持持久化。它适用于数据简单，有持久化需求，且读写QPS较高（万级别）但存储数据较简单的应用场景；例如订单计数，库存记录等功能，更新非常频繁。

# 系统架构

- Client——在初始化时，会从Config server处请求数据的分布信息，根据获取到的key和Data server的对照表，和Data server交互完成用户的请求；

- Config Server——管理Data Server节点、维护Data Server的状态信息，为了保证高可用性质，采用了一主（master）一备（slave）的方式保证可靠性；

- Data Server——负责数据存储，按照Config Server的指示完成数据复制和迁移工作，并定时给Config Server发送心跳信息。

![](https://i.postimg.cc/TPLrJ7V9/image.png)

# 负载均衡

负载均衡采用的是一致性哈希算法，简单来说，一致性哈希将整个哈希值空间组织成一个虚拟的圆环，如假设某哈希函数H的值空间为0 - 232-1（即哈希值是一个32位无符号整形），将各个服务器使用H进行一个哈希，具体可以选择服务器的ip或主机名作为关键字进行哈希，这样每台机器就能确定其在哈希环上的位置，这里假设将三台服务器使用ip地址哈希后在环空间的位置。

与直接对key进行hash的一致性哈希算法不同的是，config server首先通过hash将所有的key分到Q个bucket中，在缓存系统里bucket是负载均衡和数据迁移的基本单位，config server根据一定的策略把每个桶指派到不同的data server上，因为数据按照key做hash算法，保证了桶分布的均衡性，从而保证了数据分布的均衡性，如图所示：

![](https://i.postimg.cc/P5GyGPXZ/image.png)

