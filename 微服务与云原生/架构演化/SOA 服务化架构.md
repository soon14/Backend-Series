# SOA 与服务化架构

由于互联网应用规模迅速增长，集中式架构已无法做到无限制地提升系统的吞吐量，它只能通过增加服务器的配置有限度地提升系统的处理能力，这种伸缩方式被称为垂直伸缩。与之相对的伸缩方式被称为水平伸缩，水平伸缩能够仅通过增减服务器数量相应地提升和降低系统的吞吐量。这种分布式系统架构，在理论上为吞吐量的提升提供了无限的可能。因此，用于搭建互联网应用的服务器也渐渐放弃了昂贵的小型机，转而采用大量的廉价 PC 服务器。

SOA 即面向服务架构，也是一个特别宽泛的概念，其核心就是模块化开发与分布式计算，其向团队和个人，涉及具体服务在业务、架构和开发方面的实施，在架构体系上包括服务治理、服务编排等内容。通过服务接口来通讯，面向服务的设计模式，最终需要总线集成服务，而且大部分时候还共享数据库，出现单点故障的时候会导致总线层面的故障，更进一步可能会把数据库拖垮，因此也需要更加独立的设计方案的出现。

![](https://ww1.sinaimg.cn/large/007rAy9hgy1g28a4k8ii6j30lk0goaaw.jpg)

由于分布式系统十分复杂，因此产生了大量的用于简化分布式系统开发的分布式中间件和分布式数据库，服务化的架构设计理念也被越来越多的公司所认同。2011 年前后，阿里巴巴开源的 Dubbo 框架成为对后世影响深远的一款分布式服务框架。Dubbo 官方文档公布了一张有关 SOA 系统演化过程的图片（见图 1-3），彻底奏响了分布式和 SOA 时代的最强音。服务发现、负载均衡、失效转移、动态扩容、数据分片、调用链路监控等分布式系统的核心功能也一个个趋于成熟。

![](https://tva1.sinaimg.cn/large/007rAy9hgy1g35rmkfy3hj30jg05ut9c.jpg)

# 系统扩展

![](https://i.postimg.cc/3Rqf3CBz/image.png)

上图从三个维度概括了一个系统的扩展过程，x 轴即水平复制，即在负载均衡服务器后增加多个 web 服务器。z 轴是对数据库的扩展，即分库分表(分库是将关系紧密的表放在一台数据库服务器上，分表是因为一张表的数据太多，需要将一张表的数据通过 hash 放在不同的数据库服务器上)。y 轴是业务方向的扩展，才能将巨型应用分解为一组不同的服务，例如订单管理中心、客户信息管理中心、商品管理中心等等。

2002 年左右，亚马逊 CEO 贝佐斯就在亚马逊内部强制推行了以下六项原则（摘自酷壳网）。

- 所有团队开发的程序模块都要通过 Service 接口将数据与功能开放出来。
  团队间程序模块的信息通信都要通过上述接口。
  除上述通信方式外，其他方式一概不允许使用：不能直接连接程序，不能直接读取其他团队的数据库，不能使用共享内存模式，不能使用他人模块的内部入口等。
  任何技术都可以使用，比如 HTTP、Corba、发布/订阅、自定义的网络协议等。
  所有的 Service 接口，毫无例外，都必须从骨子里到表面上被设计成能对外界开放的。也就是说，团队必须做好规划与设计，以便未来把接口开放给全世界的程序员。
  不按照以上要求做的人会被炒鱿鱼。

# 分布式系统的挑战

分布式场景下比较著名的难题就是 CAP 定理。CAP 定理认为，在分布式系统中，系统的一致性（Consistency）、可用性（Availability）、分区容忍性（Partition tolerance），三者不可能同时兼顾。在分布式系统中，由于网络通信的不稳定性，分区容忍性是必须要保证的，因此在设计应用的时候就需要在一致性和可用性之间权衡选择。互联网应用比企业级应用更加偏向保持可用性，因此通常用最终一致性代替传统事务的 ACID 强一致性。
